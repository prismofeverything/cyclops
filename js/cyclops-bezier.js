var keyframes = [
  {
    "property":"Position",
    "time":0,
    "value":[
      50,
      250,
      0
    ],
    "in":{
      "type":"linear",
      "speed":0,
      "influence":16.666666667
    },
    "out":{
      "type":"linear",
      "speed":2285.65147703061,
      "influence":16.666666667
    }
  },
  {
    "property":"Position",
    "time":0.16666666666667,
    "value":[
      430.941912838435,
      250,
      0
    ],
    "in":{
      "type":"bezier",
      "speed":286.799362693444,
      "influence":55.4703658885224
    },
    "out":{
      "type":"bezier",
      "speed":286.799362693447,
      "influence":25.2976760465519
    }
  },
  {
    "property":"Position",
    "time":1.16666666666667,
    "value":[
      450,
      250,
      0
    ],
    "in":{
      "type":"bezier",
      "speed":0,
      "influence":42.2268432380305
    },
    "out":{
      "type":"bezier",
      "speed":0,
      "influence":16.666666667
    }
  }
];

var framevalues = {
  "property":"Position",
  "values":[
    {
      "time":0,
      "value":[
        50,
        250,
        0
      ]
    },
    {
      "time":0.03333333333333,
      "value":[
        164.84626748082,
        250,
        0
      ]
    },
    {
      "time":0.06666666666667,
      "value":[
        277.426363320496,
        250,
        0
      ]
    },
    {
      "time":0.1,
      "value":[
        358.781501674219,
        250,
        0
      ]
    },
    {
      "time":0.13333333333333,
      "value":[
        408.755161490925,
        250,
        0
      ]
    },
    {
      "time":0.16666666666667,
      "value":[
        430.941912838435,
        250,
        0
      ]
    },
    {
      "time":0.2,
      "value":[
        436.165223847315,
        250,
        0
      ]
    },
    {
      "time":0.23333333333333,
      "value":[
        438.890303999275,
        250,
        0
      ]
    },
    {
      "time":0.26666666666667,
      "value":[
        440.814755794404,
        250,
        0
      ]
    },
    {
      "time":0.3,
      "value":[
        442.300154918157,
        250,
        0
      ]
    },
    {
      "time":0.33333333333333,
      "value":[
        443.498253211278,
        250,
        0
      ]
    },
    {
      "time":0.36666666666667,
      "value":[
        444.489960258383,
        250,
        0
      ]
    },
    {
      "time":0.4,
      "value":[
        445.324527570288,
        250,
        0
      ]
    },
    {
      "time":0.43333333333333,
      "value":[
        446.034619669319,
        250,
        0
      ]
    },
    {
      "time":0.46666666666667,
      "value":[
        446.643251671769,
        250,
        0
      ]
    },
    {
      "time":0.5,
      "value":[
        447.167390194473,
        250,
        0
      ]
    },
    {
      "time":0.53333333333333,
      "value":[
        447.619991959398,
        250,
        0
      ]
    },
    {
      "time":0.56666666666667,
      "value":[
        448.011236887163,
        250,
        0
      ]
    },
    {
      "time":0.6,
      "value":[
        448.349314065388,
        250,
        0
      ]
    },
    {
      "time":0.63333333333333,
      "value":[
        448.64094457433,
        250,
        0
      ]
    },
    {
      "time":0.66666666666667,
      "value":[
        448.891741906107,
        250,
        0
      ]
    },
    {
      "time":0.7,
      "value":[
        449.106468126259,
        250,
        0
      ]
    },
    {
      "time":0.73333333333333,
      "value":[
        449.28922086338,
        250,
        0
      ]
    },
    {
      "time":0.76666666666667,
      "value":[
        449.443573114584,
        250,
        0
      ]
    },
    {
      "time":0.8,
      "value":[
        449.572680110504,
        250,
        0
      ]
    },
    {
      "time":0.83333333333333,
      "value":[
        449.679362745482,
        250,
        0
      ]
    },
    {
      "time":0.86666666666667,
      "value":[
        449.766174094615,
        250,
        0
      ]
    },
    {
      "time":0.9,
      "value":[
        449.835453614786,
        250,
        0
      ]
    },
    {
      "time":0.93333333333333,
      "value":[
        449.889372363257,
        250,
        0
      ]
    },
    {
      "time":0.96666666666667,
      "value":[
        449.929971729888,
        250,
        0
      ]
    },
    {
      "time":1,
      "value":[
        449.95919762625,
        250,
        0
      ]
    },
    {
      "time":1.03333333333333,
      "value":[
        449.978931721627,
        250,
        0
      ]
    },
    {
      "time":1.06666666666667,
      "value":[
        449.991021111926,
        250,
        0
      ]
    },
    {
      "time":1.1,
      "value":[
        449.997307726625,
        250,
        0
      ]
    },
    {
      "time":1.13333333333333,
      "value":[
        449.999658813433,
        250,
        0
      ]
    },
    {
      "time":1.16666666666667,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.2,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.23333333333333,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.26666666666667,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.3,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.33333333333333,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.36666666666667,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.4,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.43333333333333,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.46666666666667,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.5,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.53333333333333,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.56666666666667,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.6,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.63333333333334,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.66666666666667,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.7,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.73333333333334,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.76666666666667,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.8,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.83333333333334,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.86666666666667,
      "value":[
        450,
        250,
        0
      ]
    },
    {
      "time":1.9,
      "value":[
        450,
        250,
        0
      ]
    }
  ]
};

function normalizeData(input){
  var min = 1000000000;
  var max = 0;
  var output = [];

  for(var i = 0; i < input.length; i++){
    if(min > input[i]){
      min = input[i];
    }
    if(max < input[i]){
      max = input[i];
    }
  }

  for(var i = 0; i < input.length; i++){
    output.push( (input[i] - min) / (max - min) );
  }

  return output;
}

function extractKeyframes(keyframes) {
  var xs = [];
  var ys = [];
  var ins = [];
  var outs = [];
  // var speedins = [];
  // var influenceins = [];
  // var speedouts = [];
  // var influenceouts = [];
  for (var i = 0; i < keyframes.length; i++) {
    var keyframe = keyframes[i];
    xs.push(keyframe.time);
    ys.push(keyframe.value[0]);
    ins.push(keyframe.in.speed);
    outs.push(keyframe.out.speed);
    // speedins.push(keyframe.in.speed);
    // influenceins.push(keyframe.in.influence);
    // speedouts.push(keyframe.out.speed);
    // influenceouts.push(keyframe.out.influence);
  }

  return [xs, ys, ins, outs];
  // return [xs, ys, speedins, influenceins, speedouts, influenceouts];
}

function extractFramevalues(framevalues) {
  var xs = [];
  var ys = [];

  for (var i = 0; i < framevalues.values.length; i++) {
    var framevalue = framevalues.values[i];
    xs.push(framevalue.time);
    ys.push(framevalue.value[0]);
  }

  return [xs, ys];
}

cyclops.plotFit = function(processing) {
  var frames;
  var framefit;
  var keys;
  var keyfit;
  var snapshot, spline;

  function fitData(fit, dx) {
    // transform a fitted function into an array of data

    var data = [];
    var index = 0;
    for (x = 0.0; x <= 1.0; x += dx) {
      var y = fit(x);
      data[index] = y;
      index++;
    }
    return data;
  }

  function drawData(data) {
    // draw an arbitrary array of data
    data = normalizeData(data);
    var dx = processing.width / (data.length - 1);
    var xprev = 0.0;
    var yprev = data[0];
    for (d = 1; d < data.length; d++) {
      var x = xprev + dx;
      var y = data[d];
      processing.line(xprev, 
                      (1 - yprev) * processing.height, 
                      x, 
                      (1 - y) * processing.height);
      xprev = x;
      yprev = y;
    }
  }

  processing.setup = function() {
    processing.size(1200, 600);
    frames = extractFramevalues(framevalues);
    framefit = cyclops.generateCubic(frames[0], frames[1]);
    keys = extractKeyframes(keyframes);
    keyspline = new numeric.Spline(keys[0], keys[1], keys[1], keys[2], keys[3]);
    keyfit = function(x) {return keyspline.at(x)};

    snapshot = fitData(framefit, 0.01);
    spline = fitData(keyfit, 0.01);
  }

  processing.draw = function() {
    processing.stroke(0, 250, 0);
    drawData(snapshot);
    processing.stroke(250, 0, 0);
    drawData(spline);
  };
  
  return {
    
  }
}

// window.onload = function() {
//   var canvas = document.getElementById("canvas");
//   var processingInstance = new Processing(canvas, cyclops.plotFit);
// };
